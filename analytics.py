import streamlit as st
import pandas as pd
import os
import requests
from datetime import datetime
import openai

# ---- ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿ ----
load_dotenv()

client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

st.title("å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°æŠ½å‡ºAI for é£²é£Ÿåº—")

# é™¤å¤–ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã‚„ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã§æŒ‡å®š
exclude_items = st.text_input(
    "æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼AIææ¡ˆã§é™¤å¤–ã—ãŸã„é£Ÿæãƒ»æ—¢å­˜å•†å“åã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: ç‰›ãŸã‚“,éº¦é£¯,ã¨ã‚ã‚,ãƒ†ãƒ¼ãƒ«ã‚¹ãƒ¼ãƒ—,ç‰›ãŸã‚“ä¸¼ï¼‰",
    value="ç‰›ãŸã‚“,éº¦é£¯,ã¨ã‚ã‚,ãƒ†ãƒ¼ãƒ«ã‚¹ãƒ¼ãƒ—,ç‰›ãŸã‚“ä¸¼"
).replace(" ", "").split(",")

# or
# exclude_items = st.multiselect(
#     "æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼AIã§é™¤å¤–ã—ãŸã„å•†å“ãƒ»é£Ÿæã‚’é¸ã‚“ã§ãã ã•ã„",
#     ["ç‰›ãŸã‚“", "éº¦é£¯", "ã¨ã‚ã‚", "ãƒ†ãƒ¼ãƒ«ã‚¹ãƒ¼ãƒ—", "ç‰›ãŸã‚“ä¸¼", "ã‚µãƒ¼ãƒ¢ãƒ³", "ãƒãƒ†ã‚µãƒ©", ...],
#     default=["ç‰›ãŸã‚“", "éº¦é£¯", "ã¨ã‚ã‚", "ãƒ†ãƒ¼ãƒ«ã‚¹ãƒ¼ãƒ—", "ç‰›ãŸã‚“ä¸¼"]
# )

exclude_text = "ã€".join(exclude_items)

area = st.text_input("ãŠåº—ã®ã‚¨ãƒªã‚¢ï¼ˆä¾‹ï¼šæ¸‹è°·ã€ä»™å°é§…å‰ãªã©ï¼‰")
category = st.selectbox(
    "ãŠåº—ã‚«ãƒ†ã‚´ãƒª",
    ["ã‚¤ã‚¿ãƒªã‚¢ãƒ³", "å’Œé£Ÿ", "ä¸­è¯", "ãƒ•ãƒ¬ãƒ³ãƒ", "å±…é…’å±‹", "ä¸²ç„¼ãï¼ˆç‰›ã‚¿ãƒ³ï¼‰", "ãã®ä»–"]
)
uploaded_file = st.file_uploader("Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„", type=["xlsx"])

if uploaded_file is not None:
    df = pd.read_excel(uploaded_file)
    st.write("ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼")
    st.dataframe(df.head())

    # --- ä¼šè¨ˆæ—¥æ™‚ã‹ã‚‰æ™‚é–“å¸¯ï¼ˆãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼/ãã®ä»–ï¼‰ã‚’è‡ªå‹•åˆ¤å®š ---
    def classify_time(row):
        try:
            hour = pd.to_datetime(row["ä¼šè¨ˆæ—¥æ™‚"]).hour
        except Exception:
            return "ä¸æ˜"
        if 11 <= hour < 15:
            return "ãƒ©ãƒ³ãƒ"
        elif 17 <= hour < 22:
            return "ãƒ‡ã‚£ãƒŠãƒ¼"
        else:
            return "ãã®ä»–"

    df["æ™‚é–“å¸¯"] = df.apply(classify_time, axis=1)

    # --- æ™‚é–“å¸¯ã”ã¨ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º ---
    for time_zone in ["ãƒ©ãƒ³ãƒ", "ãƒ‡ã‚£ãƒŠãƒ¼"]:
        sub = df[df["æ™‚é–“å¸¯"] == time_zone]
        st.write(f"## â° {time_zone}ã‚¿ã‚¤ãƒ å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°")
        if len(sub) == 0:
            st.info(f"{time_zone}ã‚¿ã‚¤ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
            continue
        ranking = (
            sub.groupby(['åˆ†é¡åç§°', 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼åç§°'])['è²©å£²é‡‘é¡(ç¨è¾¼)']
            .sum().reset_index()
            .sort_values(['åˆ†é¡åç§°', 'è²©å£²é‡‘é¡(ç¨è¾¼)'], ascending=[True, False])
        )
        st.dataframe(ranking)

    # --- AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆã¯ãƒ«ãƒ¼ãƒ—å¤–ã§ä½œã‚‹ï¼ ---
    lunch_ranking_text = (
        df[df["æ™‚é–“å¸¯"] == "ãƒ©ãƒ³ãƒ"]
        .groupby(['åˆ†é¡åç§°', 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼åç§°'])['è²©å£²é‡‘é¡(ç¨è¾¼)']
        .sum().reset_index()
        .sort_values(['åˆ†é¡åç§°', 'è²©å£²é‡‘é¡(ç¨è¾¼)'], ascending=[True, False])
        .head(10)
        .to_string(index=False)
    )

    dinner_ranking_text = (
        df[df["æ™‚é–“å¸¯"] == "ãƒ‡ã‚£ãƒŠãƒ¼"]
        .groupby(['åˆ†é¡åç§°', 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼åç§°'])['è²©å£²é‡‘é¡(ç¨è¾¼)']
        .sum().reset_index()
        .sort_values(['åˆ†é¡åç§°', 'è²©å£²é‡‘é¡(ç¨è¾¼)'], ascending=[True, False])
        .head(10)
        .to_string(index=False)
    )
    
    # --- å…¨ä½“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚‚è¡¨ç¤ºï¼ˆã‚‚ã¨ã®ä»•æ§˜ï¼‰ ---
    st.write("ğŸ† åˆ†é¡åˆ¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå…¨æ™‚é–“å¸¯ãƒ»åˆè¨ˆé‡‘é¡é †ï¼‰")
    overall_ranking = (
        df.groupby(['åˆ†é¡åç§°', 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼åç§°'])['è²©å£²é‡‘é¡(ç¨è¾¼)']
        .sum().reset_index()
        .sort_values(['åˆ†é¡åç§°', 'è²©å£²é‡‘é¡(ç¨è¾¼)'], ascending=[True, False])
    )
    st.dataframe(overall_ranking)

    ranking_summary = overall_ranking.head(20).to_string(index=False)  # å…¨ä½“ä¸Šä½20ä»¶ã‚’æ–‡å­—åˆ—åŒ–

    # --- ãƒœã‚¿ãƒ³â‘ ï¼šAIè¦ç´„ ---
    if st.button("AIã§ãŠåº—ã®æ–¹å‘æ€§ã‚’è¦ç´„ã™ã‚‹"):
        payload = [
            {"role": "system", "content":
                "ã‚ãªãŸã¯æ¥­å‹™ç”¨ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³åˆ†æã¨ãƒ¬ã‚·ãƒ”é–‹ç™ºã«é•·ã‘ãŸãƒ—ãƒ­AIã‚·ã‚§ãƒ•ã§ã™ã€‚"
            },
            {"role": "user", "content": f"""
ä¸‹è¨˜ã®å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å‚è€ƒã«ã€**Markdownã®ç•ªå·ä»˜ããƒªã‚¹ãƒˆ**ã§æ¬¡ã®è¦³ç‚¹ã”ã¨ã«ç¾å ´åˆ†æã‚³ãƒ¡ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

1. ä¸»å½¹å•†å“ãƒ»ã‚«ãƒ†ã‚´ãƒªï¼šã©ã®åˆ†é¡ã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒä¸»åŠ›ã‹ï¼Ÿ
2. æ™‚é–“å¸¯ã”ã¨ã®å‚¾å‘ï¼šãƒ©ãƒ³ãƒã¨ãƒ‡ã‚£ãƒŠãƒ¼ã§å£²ã‚Œç­‹ã‚„å®¢å±¤ã«é•ã„ã¯ã‚ã‚‹ã‹ï¼Ÿ
3. å‰¯èœ/ãŠã¤ã¾ã¿/ãƒ‡ã‚¶ãƒ¼ãƒˆã®å¼·ã¿ï¼šã‚µã‚¤ãƒ‰ãƒ»ã¤ã¾ã¿ãƒ»ç”˜å‘³ã®ç‰¹å¾´ã‚„äººæ°—ãƒã‚¤ãƒ³ãƒˆ
4. åˆ©ç”¨ã‚·ãƒ¼ãƒ³ãƒ»é¡§å®¢å±¤ï¼šã©ã‚“ãªä½¿ã‚ã‚Œæ–¹ï¼ˆé£²ã¿ï¼é£Ÿäº‹ï¼ä¸€äººï¼ã‚°ãƒ«ãƒ¼ãƒ—ç­‰ï¼‰ã€ã©ã‚“ãªå±¤ãŒä¸­å¿ƒã‹ï¼Ÿ
5. ç·åˆè©•ä¾¡ãƒ»æˆ¦ç•¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼šã“ã®åº—ã®å¼·ã¿ãƒ»ä»Šå¾Œã®æ–¹å‘æ€§ã‚„èª²é¡ŒãŒã‚ã‚Œã°å…·ä½“çš„ã«

ãŠé…’ã®å£²ã‚Œç­‹ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã«å¿…ãšå…¥ã‚Œã¦ãã ã•ã„ã€‚

ã€ãƒ©ãƒ³ãƒãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€‘

{lunch_ranking_text}

ã€ãƒ‡ã‚£ãƒŠãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€‘
{dinner_ranking_text}

ã€å…¨ä½“å‚¾å‘ï¼ˆå‚è€ƒï¼‰ã€‘
{ranking_summary}
            """}
        ]
        response = client.chat.completions.create(
            model="gpt-4.1",
            messages=payload,
            response_format={"type": "text"}
        )
        direction_summary = response.choices[0].message.content
        st.session_state['direction_summary'] = direction_summary  # â†ã“ã“ã§ä¿å­˜
        st.markdown("### ğŸ§­ ãŠåº—ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ–¹å‘æ€§ãƒ»ç¾å ´æŒ‡é‡ï¼ˆAIè¦ç´„ï¼‰")
        st.markdown(direction_summary)

    # --- ãƒœã‚¿ãƒ³â‘¡ï¼šè¦ç´„ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°ã€æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼AI
    if 'direction_summary' in st.session_state:
        if st.button("ã“ã®æ–¹å‘æ€§ã§æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼AIææ¡ˆã‚’å‡ºã™"):
            direction_summary = st.session_state['direction_summary']
            recipe_prompt = f"""
ã‚ãªãŸã¯æ¥­å‹™ç”¨ãƒ¬ã‚·ãƒ”ææ¡ˆã®ãƒ—ãƒ­AIã‚·ã‚§ãƒ•ã§ã™ã€‚
ä¸‹è¨˜ã®ãŠåº—ã®æ–¹å‘æ€§ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¨ãƒªã‚¢ã«ã´ã£ãŸã‚Šåˆã†ã€â€œæ–°ã—ã„å£²ã‚Œç­‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼â€ã‚’å¿…ãš3å“ã€å®Ÿå‹™ãƒ¬ãƒ™ãƒ«ã§è€ƒæ¡ˆã—ã¦ãã ã•ã„ã€‚æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆæ™‚ã¯ã€ä»¥ä¸‹ã®é£Ÿæã‚„æ—¢å­˜å•†å“ã‚’å¿…ãšé™¤å¤–ã—ã¦ãã ã•ã„ï¼š
ã€é™¤å¤–ãƒªã‚¹ãƒˆã€‘{exclude_text}

ã€ãŠåº—ã®æ–¹å‘æ€§ãƒ»æŒ‡é‡ã€‘
{direction_summary}
ã€ãŠåº—ã‚«ãƒ†ã‚´ãƒªã€‘{category}
ã€ã‚¨ãƒªã‚¢ã€‘{area}

å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ä»¥ä¸‹ã®æƒ…å ±ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ï¼š
- æ–™ç†å
- èª¬æ˜ï¼ˆç‰¹å¾´ã‚„ãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆï¼‰
- ææ–™ã¨åˆ†é‡
- èª¿ç†æ–¹æ³•ï¼ˆ3ã€œ5ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
- 1äººå‰ã®åŸä¾¡è¨ˆç®—
- è²©å£²ä¾¡æ ¼ã®ç›®å®‰ï¼ˆåŸä¾¡ç‡30%æƒ³å®šï¼‰
- å¯èƒ½ãªã‚‰Webã§å‚è€ƒã«ã—ãŸURLï¼ˆå…¬å¼ã‚„ãƒ¬ã‚·ãƒ”ã‚µã‚¤ãƒˆç­‰ï¼‰

å‡ºåŠ›ã¯markdownå½¢å¼ã§ã€‚å¿…ãš3å“ã€ç‹¬è‡ªæ€§ã‚„ç¾å ´ã«åˆºã•ã‚‹æ–°ææ¡ˆã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚
"""
            recipe_response = client.chat.completions.create(
                model="gpt-4o-search-preview-2025-03-11",
                messages=[
                    {"role": "system", "content": "ã‚ãªãŸã¯æ¥­å‹™ç”¨ãƒ¬ã‚·ãƒ”ææ¡ˆã®ãƒ—ãƒ­AIã‚·ã‚§ãƒ•ã§ã™ã€‚"},
                    {"role": "user", "content": recipe_prompt}
                ]
            )
            recipe_text = recipe_response.choices[0].message.content
            st.markdown("### ğŸ³ ã“ã®ãŠåº—ã«æœ€é©ãªæ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼AIææ¡ˆï¼ˆ3å“ï¼‰")
            st.markdown(recipe_text)
else:
    st.info("å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å‡ºã™ã«ã¯ã€ã¾ãšExcelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
